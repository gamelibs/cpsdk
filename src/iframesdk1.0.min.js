class iframeSdk{constructor(){this.pushtime=3,this.isAndroid=!!window.CpsenseAppEvent&&"function"==typeof window.CpsenseAppEvent.events,this.events_iframe={listeners:{game_time:[],game_start:[],game_score:[],game_level:[],level_end:[],interstitial:[],reward:[],beforeAd:[],interstitial_open:[],afterAd:[],interstitial_viewed:[],reward_dismissed:[],reward_viewed:[],ad_error:[]},on(e,t){this.listeners[e]&&"function"==typeof t&&this.listeners[e].push(t)},emit(e,...t){this.listeners[e]&&this.listeners[e].forEach((e=>{try{e(...t)}catch(e){console.warn("events_iframe callback error",e&&e.message)}}))},off(e,t){this.listeners[e]&&(this.listeners[e]=t?this.listeners[e].filter((e=>e!==t)):[])}},window.addEventListener("message",(e=>{try{const t=e.data;let a=null;if("string"==typeof t)try{a=JSON.parse(t)}catch(e){a=t}else a=t;if(!Array.isArray(a)){if(!a||"object"!=typeof a||!a.type)return;a=[a]}const s=[];for(const e of a)try{if(!e||"object"!=typeof e)continue;const t=e.type||e.event_type||null;if(!t)continue;const a=void 0!==e.value?e.value:void 0!==e.data?e.data:null;s.push({type:t,value:a,__raw:e})}catch(e){continue}if(!s.length)return;this.__sdklog3("[IframeSdk] 收到Android广告状态查询请求(add_ads_event/is_ads_android)"),s.forEach((e=>{this.__sdklog3("[GameStatus] 收到",e.type,"|",e.value);try{switch(e.type){case"GAME_TIME":this.events_iframe.emit("game_time",e.value),this.isAndroid&&window.CpsenseAppEvent.events(JSON.stringify([{type:e.type,value:e.value}]));break;case"GAME_START":this.events_iframe.emit("game_start",e.value),this.isAndroid&&window.CpsenseAppEvent.events(JSON.stringify([{type:e.type,value:e.value}]));break;case"LEVEL_START":this.events_iframe.emit("level_start",e.value),this.isAndroid&&window.CpsenseAppEvent.events(JSON.stringify([{type:e.type,value:e.value}]));break;case"LEVEL_END":this.events_iframe.emit("level_end",e.value),this.events_iframe.emit("game_score",e.value.score),this.events_iframe.emit("game_level",e.value.level||e.value.level_name),this.isAndroid&&window.CpsenseAppEvent.events(JSON.stringify([{type:e.type,value:e.value}]));break;case"add_ads_event":this.isAndroid?window.CpsenseAppEvent.events(JSON.stringify([{type:e.type,value:e.value}])):(console.warn("[IframeSdk] 非安卓环境，忽略 add_ads_event 请求"),this._postMessageToIframe({type:"app_ads_on",value:!1}));break;case"interstitial":this.events_iframe.emit("interstitial",e.value),this.isAndroid&&window.CpsenseAppEvent.events(JSON.stringify([{type:e.type,value:e.value}]));break;case"reward":this.events_iframe.emit("reward",e.value),this.isAndroid&&window.CpsenseAppEvent.events(JSON.stringify([{type:e.type,value:e.value}]));break;default:this.events_iframe.emit(e.type,e.value)}}catch(t){console.warn("[GameStatus] 处理消息失败:",e,t)}}))}catch(e){console.warn("[IframeSdk] 处理消息失败:",e)}})),window.CpsenseAppEventCallBack=e=>{if(this.isAndroid){const t=this;let a=null;try{a="string"==typeof e?JSON.parse(e):e}catch(e){return void console.warn("[adsdk] _appeventCallback: 无法解析回调数据",e&&e.message)}if(!Array.isArray(a)){if(!a||"object"!=typeof a||!a.type)return;a=[a]}const s=[];for(const e of a)try{if(!e||"object"!=typeof e)continue;const t=e.type||e.event_type||null;if(!t)continue;const a=void 0!==e.value?e.value:void 0!==e.data?e.data:null;s.push({type:t,value:a})}catch(e){continue}s.forEach((e=>{t.__sdklog3("[GameStatus] 收到",e.type,"|",e.value);try{switch(e.type){case"app_ads_on":this._postMessageToIframe({type:"app_ads_on",value:e.value});break;case"set_pushtime":this._postMessageToIframe({type:"set_pushtime",value:e.value});break;case"beforeAd":this._postMessageToIframe({type:"beforeAd",value:e.value});break;case"afterAd":this._postMessageToIframe({type:"afterAd",value:e.value});break;case"adViewed":this._postMessageToIframe({type:"adViewed",value:e.value});break;case"adDismissed":this._postMessageToIframe({type:"adDismissed",value:e.value});break;case"ad_error":this._postMessageToIframe({type:"ad_error",value:e.value});break;default:this.__sdklog3("[GameStatus] 未知消息类型，忽略:",e.type,e.value)}}catch(t){console.warn("[GameStatus] 处理消息失败:",e,t)}}))}},this.__sdklog3("iframeSdk 初始化成功")}_postMessageToIframe(e,t,a="cpsense-iframe-message"){let s=null,i="game-preview";if(t)if("string"==typeof t){const e=document.getElementById(t);e&&"IFRAME"===e.tagName&&(s=e.contentWindow,i=t)}else t instanceof Window?(s=t,i="window object"):t&&"IFRAME"===t.tagName&&(s=t.contentWindow,i=t.id||"iframe element");else{let e=document.getElementById("game-preview");e&&"IFRAME"===e.tagName||(e=document.getElementById("gameFrame"),i="gameFrame"),e&&"IFRAME"===e.tagName||(e=document.querySelector(".game-preview"),i=".game-preview"),e&&"IFRAME"===e.tagName||(e=document.querySelector("iframe"),i="first iframe"),e&&"IFRAME"===e.tagName&&(s=e.contentWindow)}if(!s)return console.warn(`[IframeSdk] ${a} send failed: no target iframe found`),!1;try{return s.postMessage(e,"*"),this.__sdklog3(`[IframeSdk] sent ${a} to ${i}:`,JSON.stringify(e)),!0}catch(e){return console.warn(`[IframeSdk] postMessage ${a} error:`,e),!1}}__sdklog(...e){const t=e.map((e=>"string"==typeof e?`'${e}'`:"object"==typeof e?JSON.stringify(e):String(e))).join(" ");console.log(`%c ***Ifamesdk***: ${t}`,"background-color: #390000ff; border: 2px solid #00ff00; color: #333; padding: 5px 15px; border-radius: 5px; font-weight: 500; box-shadow: 0 0 5px rgba(142, 68, 173, 0.3);")}__sdklog2(...e){const t=e.map((e=>"string"==typeof e?`'${e}'`:"object"==typeof e?JSON.stringify(e):String(e))).join(" ");console.log(`%c ***Ifamesdk***: ${t}`,"background: linear-gradient(to right, #50ad44ff, #43ff9eff); color: white; padding: 5px 15px; border-radius: 5px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);")}__sdklog3(...e){const t=e.map((e=>"string"==typeof e?`'${e}'`:"object"==typeof e?JSON.stringify(e):String(e))).join(" ");console.log(`%c ***Ifamesdk***: ${t}`,"background: linear-gradient(to right,rgba(157, 173, 68, 1),rgba(167, 173, 4, 1)); color: white; padding: 5px 15px; border-radius: 5px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);")}}var IframeSdk=new iframeSdk;window.IframeSdk=IframeSdk;