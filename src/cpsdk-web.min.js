!function(t){const e="Cpsdk",n=new Set,o=new Map;function s(t){const e={};return(t||"").replace(/^\?/,"").split("&").forEach((t=>{if(!t)return;const[n,o]=t.split("="),s=decodeURIComponent(n||"").toLowerCase(),i=decodeURIComponent(o||"");s&&(void 0===e[s]?e[s]=i:Array.isArray(e[s])?e[s].push(i):e[s]=[e[s],i])})),e}class i{constructor(){this.isInitialized=!1,this.readyCallbacks=[],this.eventCallbacks={},this.config={},this.isMath=!0,this._thirdPartyLoaded=!1,this.gameConfig=null,this.ctx={gameId:null,platformId:null};try{this._initAuto()}catch(t){try{console.warn("[Cpsdk] _initAuto failed:",t&&t.message)}catch(t){}}}init(t={}){return this.config={...this.config,...t},this.isInitialized?Promise.resolve():new Promise((t=>{setTimeout((async()=>{this.isInitialized=!0;try{"function"==typeof this._loadThirdPartyFromConfig&&await this._loadThirdPartyFromConfig()}catch(t){console.warn("自动加载第三方脚本失败:",t&&t.message?t.message:t)}this.dispatchEvent("ready",{timestamp:Date.now()});this.readyCallbacks.splice(0).forEach((t=>{try{t()}catch(t){console.error(t)}})),t()}),0)}))}ready(t){if("function"==typeof t&&this.readyCallbacks.push(t),this.isInitialized){this.readyCallbacks.splice(0).forEach((t=>{try{t()}catch(t){console.error(t)}}))}}isReady(){return this.isInitialized}addEventListener(t,e){(this.eventCallbacks[t]||=[]).push(e)}removeEventListener(t,e){const n=this.eventCallbacks[t]||[],o=n.indexOf(e);o>=0&&n.splice(o,1)}dispatchEvent(t,e){(this.eventCallbacks[t]||[]).forEach((t=>{try{t(e)}catch(t){console.error(t)}}))}getConfig(){return{...this.config}}setConfig(t){this.config={...this.config,...t}}__sdklog(...e){if("undefined"==typeof console||!console.log)return;const n=t=>{if("string"==typeof t)return t;if("object"==typeof t)try{return JSON.stringify(t)}catch(e){return String(t)}return String(t)};try{const o=(e||[]).map(n).join(" "),s="background-color: #f9f9f9; border: 2px solid #2980b9; color: #333; padding: 4px 10px; border-radius: 4px; font-weight: 500; box-shadow: 0 0 5px rgba(41, 128, 185, 0.3);",i=this&&this.config&&this.config.sdkLogStyle||t&&t.__SDK_LOG_STYLE__||s;console.log("%c[Cpsdk] "+o,i)}catch(t){try{console.log("[Cpsdk]",...e)}catch(t){}}}loadsdk(t){const e=String(t||"").trim();if(!e)return Promise.reject(new Error("无效的脚本地址"));if(n.has(e))return o.get(e)||Promise.resolve(!0);const s=new Promise(((t,o)=>{try{const s=document.createElement("script");s.async=!0,s.src=e,s.onload=()=>{n.add(e),t(!0)},s.onerror=()=>o(new Error("脚本加载失败: "+e)),(document.head||document.documentElement||document.body).appendChild(s)}catch(t){o(t)}}));return o.set(e,s),s.finally((()=>o.delete(e)))}async _loadThirdPartyFromConfig(){if(!this._thirdPartyLoaded)try{let t=[];if(this.config&&Array.isArray(this.config.thirdPartyScripts)&&(t=this.config.thirdPartyScripts),!t||!t.length)return;this._thirdPartyLoaded=!0;const n=new Set,o=[];for(const e of t)if("string"==typeof e){const t=e.trim();t&&!n.has(t)&&(n.add(t),o.push(t))}else if(e&&"object"==typeof e&&e.url){const t=String(e.url).trim();t&&!n.has(t)&&(n.add(t),o.push({url:t,type:e.type||""}))}if(!o.length)return;if("function"==typeof this.loadScript)await new Promise((t=>this.loadScript(o,(()=>t()))));else for(const t of o){const n="string"==typeof t?t:t.url;try{await this.loadsdk(n)}catch(t){console.warn(`[${e}] 第三方脚本加载失败:`,n,t.message)}}}catch(t){console.warn(`[${e}] 自动加载第三方脚本异常:`,t&&t.message?t.message:t)}}_initAuto(){let t=null;try{const e=document.querySelector('meta[name="cpsdk-gameid"]'),n=e&&e.content;null!=n&&""!==String(n).trim()&&(t=Array.isArray(n)?n[0]:n)}catch(t){}if(!t){const e=function(){try{let t=document.currentScript||null;return t||(t=Array.from(document.getElementsByTagName("script")).slice().reverse().find((t=>t.src&&/Cpsdk/i.test(t.src)))||null),t&&t.src&&s("?"+(t.src.split("?")[1]||""))||{}}catch(t){return{}}}();try{const n=Object.keys(e||{});for(const o of n)if(o&&-1!==o.indexOf("gameid")){const n=e[o];t=Array.isArray(n)?n[0]:n;break}}catch(t){}}t&&(this.ctx.gameId=String(t),Promise.resolve().then((()=>{this.loadGameConfig({gameId:this.ctx.gameId}).catch((t=>{try{console.warn("[Cpsdk] 读取游戏配置失败:",t&&t.message)}catch(t){}}))})))}async loadGameConfig(n={}){try{const o=String(n.gameId||this.ctx.gameId||"").trim();if(!o)return console.warn(`[${e}] 缺少 gameId，无法加载游戏配置`),null;let i=!1;try{const e=s(t.location&&t.location.search||""||"");i="beta"===String(e.vb||"").toLowerCase()}catch(t){}const r=t.CpsdkProdCfgBase||"https://cpsense.heiheigame.com/gameconfig/cpzhangyun/",c=t.CpsdkBetaCfgBase||"http://localhost:13200/api/v1/game/1019/",a=i?c:r;if(!a)return console.warn(`[${e}] 未配置游戏配置基址，无法加载配置`),null;let d=String(a||"").trim();const l=/\.json(?:$|[#?])/i.test(d),h=d.match(/\/api\/v1\/game\/[^/?#]+\/?$/i);if(/\{gameid\}/i.test(d)){if(d=d.replace(/\{gameid\}/gi,encodeURIComponent(o)),!/\.json(?:$|[#?])/i.test(d)){const t=d.split("#"),e=t[0],n=t[1]?"#"+t[1]:"";d=e+(e.includes(".json")?"":".json")+n}}else if(!l&&h){const t=d.indexOf("#"),e=t>=0?d.slice(t):"";let n=t>=0?d.slice(0,t):d;n=n.replace(/\/$/,"");const s=n.includes("?")?"&":"?";d=`${n}${s}cpsdk-gameid=${encodeURIComponent(o)}${e}`}else l||(d=d.replace(/\/?$/,"/"),d+=encodeURIComponent(o)+".json");const f=await fetch(d,{credentials:"include"});if(!f.ok)throw new Error(`HTTP ${f.status} for ${d}`);const g=await f.json(),m=g&&(g.data||g)||g;if(!m||"object"!=typeof m)throw new Error("游戏配置格式无效");this.gameConfig=m;try{const n=this.config&&this.config.configObjectName,s="string"==typeof n&&n.trim()?n.trim():"wop",i=t&&t[s],r=function(t,n,o){const s=Object(o||{});try{let o=t&&(t.raw||t.game)||null;const i=t&&(t.sdk||t.sdkConfig),r=t&&t.ads,c=t&&t.analytics;if(!o&&t&&"object"==typeof t&&("gameId"in t||"title"in t||"isAd"in t||"isDot"in t)&&(o=t),o&&"object"==typeof o){Object.keys(o).forEach((t=>{const e=o[t];"info"!==t&&"sdkConfig"!==t&&(s[t]=e)})),!i&&o.sdkConfig&&(s.sdk=o.sdkConfig);try{const t=o&&o.title||o&&o.info&&o.info.title||"";t&&(s.gameTitle=t)}catch(t){}}i&&(s.sdk=i),r&&(s.adsConfig=r),c&&(s.analyticsConfig=c),n&&n.gameId&&(s.gameId=String(n.gameId)),n&&n.platformId&&(s.platformId=String(n.platformId)),s._from=e,s._ts=Date.now()}catch(t){try{console.warn("[Cpsdk] buildWopFromConfig failed:",t&&t.message)}catch(t){}}return s}(m,{gameId:o,platformId:this.ctx&&this.ctx.platformId},i);if(t){const e=e=>{const n=t[e];return n&&"object"==typeof n?n:(t[e]={},t[e])},n=e(s);Object.assign(n,r);const o=e("wop");o!==n&&Object.assign(o,r);try{console.log("[Cpsdk] window.wop assigned:",t.wop)}catch(t){}}this.config=this.config||{},this.config.wop=t&&t[s]?t[s]:r}catch(t){}let p=null;try{m.sdk?p=m.sdk:m.sdkConfig?p=m.sdkConfig:m.game&&m.game.sdkConfig&&(p=m.game.sdkConfig)}catch(t){}if(p&&Array.isArray(p.thirdPartyScripts)){this.config=this.config||{},this.config.thirdPartyScripts=p.thirdPartyScripts.slice();try{await this._loadThirdPartyFromConfig()}catch(t){console.warn(`[${e}] 按游戏配置加载第三方脚本失败:`,t&&t.message)}}try{this.dispatchEvent("gameconfig",{gameId:o,config:m})}catch(t){}return m}catch(t){return console.warn(`[${e}] loadGameConfig 失败:`,t&&t.message?t.message:t),null}}loadSingleScript(t,e,n=!0,o=2,s=""){let i=0;Date.now();const r=this.isMath?t+(t.includes("?")?"&":"?"):t,c=()=>{if(t.endsWith(".json")){const t=document.createElement("script");return t.async=!1,t.type=s||"systemjs-importmap",t.src=r,document.body.appendChild(t),void setTimeout((()=>e&&e(!0)),0)}const n=document.createElement("script");n.async=!1,s?n.type=s:window.stats&&window.stats.isModule&&(n.type="module"),window.stats&&window.stats.crossorigin&&(n.crossOrigin="anonymous"),n.src=r;const a=setTimeout((()=>{console.warn("脚本加载超时："+t),d(),f()}),8e3);function d(){clearTimeout(a),n.removeEventListener("load",l),n.removeEventListener("error",h),window.stats&&window.stats.insertToHead||!n.parentNode||n.parentNode.removeChild(n)}function l(){d(),e&&e(!0)}function h(){console.error("脚本加载失败："+t),d(),f()}function f(){i++,i<=o?(console.warn("重试加载脚本（"+i+"/"+o+"）："+t),c()):e&&e(!1)}n.addEventListener("load",l),n.addEventListener("error",h);try{(window.stats&&window.stats.insertToHead?document.head:document.body).appendChild(n)}catch(t){document.body.appendChild(n)}};c()}loadScript(t,e){const n=Array.isArray(t)?t.slice():[];if(!n.length)return void(e&&e());let o=0;const s=()=>{const t=n[o],i="string"==typeof t?t:t&&t.url||"",r=t&&t.type||"";this.loadSingleScript(i,(()=>{o++,o>=n.length?e&&e():s()}),!0,2,r)};s()}destroy(){this.isInitialized=!1,this.readyCallbacks=[],this.eventCallbacks={},this.config={},console.log("Cpsdk 已销毁")}}const r=Object.assign(new i,{create:t=>{const e=new i;return t&&e.setConfig(t),e}});t[e]||(t[e]=r)}(window);